# Bug Fixes - 2026-01-15

Tracking document for orchestration bug fixes on branch `feature/config-path-env-var`.

## Bugs Fixed

### Bug 4: Session File Deleted Prematurely

**Status:** Fixed

**Files Modified:**
- `packages/core/src/session/session-service.ts`
- `packages/core/src/session/types.ts` (added `promptContent` to `WorkerSpawnRequest`)

**Changes:**
- Removed auto-cleanup logic from `list()` and `listWithCleanupInfo()`
- Sessions are NEVER auto-deleted - only explicit user action removes them
- Added `worktreeMissing` computed flag for UI warnings
- Expanded `restart()` to work with any non-terminal status (not just `stuck`)

### Bug 1+2: Ralph Pattern + /ship Bypass

**Status:** Fixed

**Files Modified:**
- `packages/core/src/session/worker-prompt-builder.ts`

**Changes:**
- Refactored `WorkerPromptBuilder.build()` to branch on execution mode
- Added `buildRalphWorkflow()` for single-task-per-session Ralph mode
- Added `buildSingleWorkflow()` for autonomous mode (keeps `/ship`)
- Ralph mode prompts explicitly say "Do NOT use /ship"
- Split common sections into separate methods for clarity

### Bug 3: Prompt File Reference vs Inline

**Status:** Fixed

**Files Modified:**
- `packages/core/src/session/types.ts`
- `packages/core/src/session/session-service.ts`
- `packages/core/src/spawner/windows-terminal-spawner.ts`
- `packages/core/src/spawner/docker-spawner.ts`

**Changes:**
- Added `promptContent` field to `WorkerSpawnRequest`
- Updated `spawn()` and `restart()` to read and pass prompt content
- WindowsTerminalSpawner now pipes prompt via stdin: `type ".claude\session-prompt.md" | claude -p -`
- DockerSpawner now pipes prompt via stdin: `cat /workspace/.claude/session-prompt.md | claude -p -`
- Prompt file still written for debugging/reference

## Testing

### Bug 4 Test
1. Create session, wait for status `complete`
2. Delete worktree directory manually
3. Run `orch list` - session should appear with `worktreeMissing: true`
4. Run `orch restart` on session with worktree - should respawn
5. Run `orch restart` on session without worktree - should fail gracefully

### Bug 1+2 Test
1. Create issue with 3 tasks in IMPLEMENTATION_PLAN.md
2. Start Ralph session: `orch spawn --mode ralph`
3. Watch worker - should complete ONE task only
4. Verify status becomes `complete` (not `shipping`)
5. Verify orchestrator respawns for next task

### Bug 3 Test
1. Start session (Windows Terminal)
2. Verify worker starts and receives full prompt
3. Check `.claude/session-prompt.md` exists (for debugging)
4. For Docker: Same test in container

## Related

- Findings doc: `vault/Scratch Pad/orchestration-findings-2026-01-15.md`
- Plan file: `~/.claude/plans/melodic-sleeping-locket.md`
